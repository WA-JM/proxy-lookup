<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Tool | W Advisors</title>
    <style>
        :root {
            --navy: #1a2e4a;
            --navy-light: #243d63;
            --gold: #c5a55a;
            --gold-light: #ddc07a;
            --bg: #f5f6f8;
            --card-bg: #ffffff;
            --text: #2c3e50;
            --text-muted: #6c7a89;
            --success: #27ae60;
            --success-bg: #eafaf1;
            --error: #c0392b;
            --error-bg: #fdf0ed;
            --border: #e1e5eb;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100%;
            overflow: hidden;
        }

        /* -- Full-height app layout -- */
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* -- Header -- */
        header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: white;
            padding: 10px 24px;
            flex-shrink: 0;
        }
        header h1 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        /* -- Search Bar -- */
        .search-bar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 10px 24px;
            flex-shrink: 0;
        }
        .search-row {
            display: flex;
            gap: 12px;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }
        .search-row .form-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .search-row label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .search-row input {
            padding: 7px 12px;
            border: 1.5px solid var(--border);
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            width: 160px;
        }
        .search-row input:focus { border-color: var(--gold); }
        .search-row input::placeholder { color: #b0b8c4; }
        .btn-search {
            padding: 7px 20px;
            background: var(--navy);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-search:hover { background: var(--navy-light); }
        .btn-search:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Progress inline */
        .progress-inline {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-left: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .progress-inline .step {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .progress-inline .step.done { color: var(--success); }
        .progress-inline .step.active { color: var(--text); font-weight: 500; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            display: inline-block;
            width: 12px; height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        /* -- Main content area -- */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            min-height: 0;
        }

        /* -- Left Panel: Results + Calculator -- */
        .left-panel {
            width: 420px;
            min-width: 420px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            background: var(--card-bg);
        }

        /* Result summary */
        .result-banner {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: none;
        }
        .result-banner.visible { display: block; }
        .result-banner.success { background: var(--success-bg); }
        .result-banner.error { background: var(--error-bg); }
        .result-summary {
            font-size: 15px;
            font-weight: 600;
        }
        .result-banner.success .result-summary { color: var(--success); }
        .result-banner.error .result-summary { color: var(--error); }
        .result-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Detail row */
        .detail-row {
            display: flex;
            gap: 12px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        .detail-item {
            flex: 1;
            min-width: 80px;
        }
        .detail-item label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .detail-item .value {
            font-size: 13px;
            font-weight: 500;
        }
        .detail-item .value.shares {
            font-size: 18px;
            font-weight: 700;
            color: var(--navy);
        }

        /* Calculator section */
        .calc-section {
            padding: 12px 16px;
            display: none;
        }
        .calc-section.visible { display: block; }

        .calc-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .calc-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        .calc-row label {
            font-size: 12px;
            min-width: 120px;
            color: var(--text);
        }
        .calc-input {
            width: 120px;
            padding: 5px 8px;
            border: 1.5px solid var(--border);
            border-radius: 5px;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            text-align: right;
        }
        .calc-input:focus { border-color: var(--gold); }
        .calc-input::placeholder { color: #c5cbd3; }
        .calc-input.subtract { border-left: 3px solid var(--error); }
        .calc-input.add { border-left: 3px solid var(--success); }

        .calc-divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 10px 0;
        }

        /* Result gauge */
        .calc-result {
            text-align: center;
            padding: 10px;
        }
        .calc-pct {
            font-size: 42px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
            transition: color 0.3s;
        }
        .calc-pct-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(191, 54, 12, 0.3); }
            50% { box-shadow: 0 0 20px 6px rgba(191, 54, 12, 0.25); }
        }
        .severity-high-glow {
            animation: pulseGlow 1.8s ease-in-out infinite;
            border: 2px solid #bf360c;
        }

        .calc-breakdown {
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.6;
        }
        .calc-breakdown .num {
            font-weight: 600;
            color: var(--text);
        }

        .filing-link {
            display: inline-block;
            padding: 8px 16px;
            font-size: 12px;
            color: var(--navy);
            text-decoration: none;
            border-bottom: 1px dashed var(--navy);
        }
        .filing-link:hover { border-bottom-style: solid; }

        /* -- Right Panel: Proxy Document -- */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        .right-panel iframe {
            flex: 1;
            width: 100%;
            border: none;
        }

        /* -- Welcome state (before search) -- */
        .welcome-state {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 14px;
            text-align: center;
            padding: 40px;
        }
        .welcome-state.hidden { display: none; }

        /* -- Error -- */
        .error-msg {
            background: var(--error-bg);
            color: var(--error);
            padding: 10px 16px;
            font-size: 13px;
            display: none;
        }
        .error-msg.visible { display: block; }

        /* -- Responsive -- */
        @media (max-width: 900px) {
            .main-content { flex-direction: column; }
            .left-panel {
                width: 100%;
                min-width: 0;
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 50vh;
            }
            .right-panel { min-height: 300px; }
        }
        @media (max-width: 600px) {
            .search-row { flex-wrap: wrap; }
            .search-row input { width: 100%; }
            .calc-row { flex-direction: column; align-items: flex-start; gap: 3px; }
            .calc-row label { min-width: auto; }
            .calc-input { width: 100%; }
        }
    </style>
</head>
<body>

<div class="app">
    <header>
        <h1>Proxy Tool</h1>
    </header>

    <div class="search-bar">
        <form id="searchForm">
            <div class="search-row">
                <div class="form-group">
                    <label for="ticker">Ticker</label>
                    <input type="text" id="ticker" placeholder="e.g. AAPL" autocomplete="off" required>
                </div>
                <div class="form-group">
                    <label for="person">Person</label>
                    <input type="text" id="person" placeholder="e.g. Pickett or Tim Cook" autocomplete="off" required>
                </div>
                <button type="submit" class="btn-search" id="searchBtn">Look Up</button>
                <div class="progress-inline" id="progressSteps"></div>
            </div>
        </form>
        <div class="error-msg" id="errorMsg"></div>
    </div>

    <div class="main-content">
        <!-- Left: Summary + Calculator -->
        <div class="left-panel" id="leftPanel">
            <div class="result-banner" id="resultBanner">
                <div class="result-summary" id="resultSummary"></div>
                <div class="result-meta" id="resultMeta"></div>
            </div>

            <div class="detail-row" id="detailRow" style="display:none;"></div>

            <!-- Calculator -->
            <div class="calc-section" id="calcSection">
                <div class="calc-section-title">Shares Sold</div>
                <div class="calc-row">
                    <label>Shares sold</label>
                    <input type="text" class="calc-input subtract" id="calcSold" placeholder="0" oninput="recalculate()">
                </div>

                <hr class="calc-divider">

                <div class="calc-section-title" id="adjustTitle">Adjustments since proxy</div>
                <div class="calc-row">
                    <label style="color:var(--success);">+ Addition 1</label>
                    <input type="text" class="calc-input add" id="calcAdd1" placeholder="0" oninput="recalculate()">
                </div>
                <div class="calc-row">
                    <label style="color:var(--success);">+ Addition 2</label>
                    <input type="text" class="calc-input add" id="calcAdd2" placeholder="0" oninput="recalculate()">
                </div>
                <div class="calc-row">
                    <label style="color:var(--success);">+ Addition 3</label>
                    <input type="text" class="calc-input add" id="calcAdd3" placeholder="0" oninput="recalculate()">
                </div>
                <div class="calc-row" style="margin-top: 6px;">
                    <label style="color:var(--error);">&minus; Subtraction 1</label>
                    <input type="text" class="calc-input subtract" id="calcSub1" placeholder="0" oninput="recalculate()">
                </div>
                <div class="calc-row">
                    <label style="color:var(--error);">&minus; Subtraction 2</label>
                    <input type="text" class="calc-input subtract" id="calcSub2" placeholder="0" oninput="recalculate()">
                </div>
                <div class="calc-row">
                    <label style="color:var(--error);">&minus; Subtraction 3</label>
                    <input type="text" class="calc-input subtract" id="calcSub3" placeholder="0" oninput="recalculate()">
                </div>

                <hr class="calc-divider">

                <div class="calc-result" id="calcResult">
                    <div class="calc-pct" id="calcPct">0.0%</div>
                    <div class="calc-pct-label">of adjusted proxy stock sold</div>
                    <div id="calcBadge"></div>
                    <div class="calc-breakdown" id="calcBreakdown"></div>
                </div>
            </div>

            <div style="padding: 8px 16px;">
                <a class="filing-link" id="filingLink" href="#" target="_blank" rel="noopener" style="display:none;">View full filing on EDGAR &rarr;</a>
            </div>
        </div>

        <!-- Right: Proxy Document -->
        <div class="right-panel" id="rightPanel">
            <div class="welcome-state" id="welcomeState">
                Enter a ticker and person name to look up<br>beneficial ownership from the latest DEF 14A proxy.
            </div>
        </div>
    </div>
</div>

<script>
// =========================================
// Proxy Tool — Client-Side
// =========================================

const PROXY_BASE = 'https://sec-proxy.jacob-ad2.workers.dev';

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// — UI helpers —
const $ = id => document.getElementById(id);

function setSteps(steps) {
    $('progressSteps').innerHTML = steps.map(s => {
        const icon = s.status === 'done' ? '&#10003;'
                   : s.status === 'active' ? '<span class="spinner"></span>'
                   : '&#8226;';
        return `<span class="step ${s.status}"><span class="icon">${icon}</span> ${s.label}</span>`;
    }).join('');
}

function clearSteps() { $('progressSteps').innerHTML = ''; }

function showError(msg) {
    const el = $('errorMsg');
    el.textContent = msg;
    el.classList.add('visible');
}
function clearError() { $('errorMsg').classList.remove('visible'); }

// — Fetch with SEC-friendly headers —
async function secFetch(url, opts = {}) {
    const proxyUrl = `${PROXY_BASE}/?url=${encodeURIComponent(url)}`;
    const resp = await fetch(proxyUrl, { ...opts });
    if (!resp.ok) throw new Error(`HTTP ${resp.status} fetching ${url}`);
    return resp;
}

// — Step 1: Resolve ticker → CIK —
async function resolveTicker(ticker) {
    const resp = await secFetch('https://www.sec.gov/files/company_tickers.json');
    const data = await resp.json();
    const upper = ticker.toUpperCase().trim();
    for (const entry of Object.values(data)) {
        if (entry.ticker.toUpperCase() === upper) {
            return { cik: String(entry.cik_str).padStart(10, '0'), company: entry.title };
        }
    }
    throw new Error(`Ticker "${ticker}" not found in the SEC database.`);
}

// — Step 2: Find latest DEF 14A —
async function findLatestProxy(cik) {
    const url = `https://data.sec.gov/submissions/CIK${cik}.json`;
    const resp = await secFetch(url);
    const data = await resp.json();
    const recent = data?.filings?.recent || {};
    const forms = recent.form || [];
    const accessions = recent.accessionNumber || [];
    const dates = recent.filingDate || [];
    const docs = recent.primaryDocument || [];
    for (let i = 0; i < forms.length; i++) {
        if (forms[i] === 'DEF 14A') {
            return { adsh: accessions[i], filename: docs[i], fileDate: dates[i] };
        }
    }
    throw new Error('No DEF 14A proxy filing found for this company.');
}

// — Step 3: Build URL & fetch proxy HTML —
function buildDocUrl(cik, adsh, filename) {
    const cikBare = cik.replace(/^0+/, '');
    const adshNoDash = adsh.replace(/-/g, '');
    return `https://www.sec.gov/Archives/edgar/data/${cikBare}/${adshNoDash}/${filename}`;
}

async function fetchProxyHtml(url) {
    const resp = await secFetch(url);
    return await resp.text();
}

// — Step 4: Parse ownership tables —
function cleanText(t) { return t.replace(/\s+/g, ' ').trim(); }

function extractNumber(text) {
    let c = text.replace(/\([^)]*\)/g, '').replace(/[*\u2020\u2021\u00a7\u2022]/g, '').trim();
    if (['\u2014', '\u2013', '-', ''].includes(c)) return null;
    const m = c.match(/[\d,]+/);
    if (m) {
        const n = parseInt(m[0].replace(/,/g, ''), 10);
        return isNaN(n) ? null : n;
    }
    return null;
}

function nameMatches(cellText, personName) {
    const cell = cleanText(cellText).toLowerCase();
    const name = personName.toLowerCase().trim();
    const escRe = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

    // Full name match with word boundaries
    if (new RegExp('\\b' + escRe(name) + '\\b').test(cell)) return true;

    const parts = name.split(/\s+/);
    if (parts.length >= 2) {
        let last = parts[parts.length - 1].replace(/,/g, '');
        let first = parts[0];
        const suffixes = ['jr', 'jr.', 'sr', 'sr.', 'ii', 'iii', 'iv'];
        if (suffixes.includes(last) && parts.length >= 3) last = parts[parts.length - 2].replace(/,/g, '');
        if (suffixes.includes(first) && parts.length >= 3) first = parts[1];
        // Both first and last name must appear as whole words
        if (new RegExp('\\b' + escRe(last) + '\\b').test(cell) &&
            new RegExp('\\b' + escRe(first) + '\\b').test(cell)) return true;
    }
    return false;
}

function findAsOfDate(text) {
    const plain = text.replace(/<[^>]+>/g, ' ').replace(/&nbsp;/gi, ' ').replace(/&#160;/gi, ' ').replace(/&#xa0;/gi, ' ').replace(/\u00a0/g, ' ').replace(/\s+/g, ' ');

    // Priority 1: "beneficial own...as of [date]"
    const p5 = [...plain.matchAll(/beneficial\s+own[^.]{0,120}?as\s+of\s+(?:the\s+close\s+of\s+business\s+on\s+)?(\w+\s+\d{1,2},?\s+\d{4})/gi)];
    if (p5.length > 0) return p5[p5.length - 1][1].trim();

    // Priority 2: "information...as of [date]"
    const p6 = [...plain.matchAll(/information[^.]{0,80}?as\s+of\s+(\w+\s+\d{1,2},?\s+\d{4})/gi)];
    if (p6.length > 0) return p6[p6.length - 1][1].trim();

    // Priority 3: "record date"
    const p4 = [...plain.matchAll(/record\s+date[^.]*?(\w+\s+\d{1,2},?\s+\d{4})/gi)];
    if (p4.length > 0) return p4[p4.length - 1][1].trim();

    // Priority 4: Generic "as of [date]"
    const p1 = [...plain.matchAll(/as\s+of\s+(?:the\s+close\s+of\s+business\s+on\s+)?(\w+\s+\d{1,2},?\s+\d{4})/gi)];
    if (p1.length > 0) return p1[p1.length - 1][1].trim();

    const p2 = [...plain.matchAll(/as\s+of\s+(\w+\s+\d{1,2}\s+\d{4})/gi)];
    if (p2.length > 0) return p2[p2.length - 1][1].trim();

    const p3 = [...plain.matchAll(/as\s+of\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/gi)];
    if (p3.length > 0) return p3[p3.length - 1][1].trim();

    return null;
}

function findOwnershipTablePositions(html) {
    const positions = [];
    const tableRegex = /<table\b[^>]*>/gi;
    let match;
    while ((match = tableRegex.exec(html)) !== null) {
        const tableStart = match.index;
        let depth = 1;
        let pos = tableStart + match[0].length;
        while (depth > 0 && pos < html.length) {
            const nextOpen = html.indexOf('<table', pos);
            const nextClose = html.indexOf('</table', pos);
            if (nextClose === -1) break;
            if (nextOpen !== -1 && nextOpen < nextClose) { depth++; pos = nextOpen + 6; }
            else { depth--; pos = nextClose + 8; }
        }
        const tableEnd = pos;
        const tableHtml = html.substring(tableStart, tableEnd);
        const tableText = tableHtml.replace(/<[^>]+>/g, ' ').replace(/&nbsp;/gi, ' ').toLowerCase();
        if ((tableText.includes('beneficial own') || tableText.includes('amount and nature'))
            && (tableText.includes('name') || tableText.includes('beneficial owner'))
            && /\d{1,3}(,\d{3})+/.test(tableHtml)) {
            positions.push({ start: tableStart, end: tableEnd, html: tableHtml });
        }
    }
    return positions;
}

function parseOwnershipFromHtml(html, personName) {
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const tables = doc.querySelectorAll('table');
    const ownershipTables = [];

    for (const table of tables) {
        const txt = cleanText(table.textContent).toLowerCase();
        if ((txt.includes('beneficial own') || txt.includes('amount and nature'))
            && (txt.includes('name') || txt.includes('beneficial owner'))
            && /\d{1,3}(,\d{3})+/.test(table.textContent)) {
            ownershipTables.push(table);
        }
    }

    if (ownershipTables.length === 0) return { found: false, disambiguate: false, matchedNames: [], tables: [] };

    const rawTablePositions = findOwnershipTablePositions(html);
    const allTableData = [];

    for (let tblIdx = 0; tblIdx < ownershipTables.length; tblIdx++) {
        const table = ownershipTables[tblIdx];
        const rows = table.querySelectorAll('tr');
        let headerTexts = [];
        let beneficialCol = null;
        let dataRows = [];
        let matchedRows = [];

        for (const row of rows) {
            const cells = row.querySelectorAll('th, td');
            const texts = Array.from(cells).map(c => cleanText(c.textContent));
            const joined = texts.join(' ').toLowerCase();
            if (joined.includes('beneficial own') || joined.includes('amount and nature')) {
                headerTexts = texts;
                for (let j = 0; j < texts.length; j++) {
                    if (texts[j].toLowerCase().includes('beneficial own') ||
                        texts[j].toLowerCase().includes('amount and nature')) {
                        beneficialCol = j; break;
                    }
                }
                break;
            }
        }

        if (headerTexts.length === 0) {
            for (const row of rows) {
                const ths = row.querySelectorAll('th');
                if (ths.length >= 2) {
                    headerTexts = Array.from(ths).map(c => cleanText(c.textContent));
                    break;
                }
            }
        }

        for (const row of rows) {
            const cells = row.querySelectorAll('td');
            if (cells.length < 2) continue;
            const texts = Array.from(cells).map(c => cleanText(c.textContent));
            if (!texts[0] || texts[0].length < 2) continue;
            const rowData = { name: texts[0], cells: texts, isMatch: false };
            if (nameMatches(texts[0], personName)) {
                rowData.isMatch = true;
                let shares = null;
                if (beneficialCol !== null && beneficialCol < texts.length) {
                    shares = extractNumber(texts[beneficialCol]);
                }
                if (shares === null) {
                    for (let j = 1; j < texts.length; j++) {
                        const n = extractNumber(texts[j]);
                        if (n !== null && n > 0) { shares = n; break; }
                    }
                }
                matchedRows.push({ name: texts[0], shares, rowData });
            }
            dataRows.push(rowData);
        }

        const rawPos = rawTablePositions[tblIdx] || null;

        let asOfDate = 'Date not found';
        if (rawPos) {
            asOfDate = findAsOfDate(rawPos.html) || asOfDate;
            if (asOfDate === 'Date not found') {
                const nearPreceding = html.substring(Math.max(0, rawPos.start - 3000), rawPos.start);
                asOfDate = findAsOfDate(nearPreceding) || asOfDate;
            }
            if (asOfDate === 'Date not found') {
                const preceding = html.substring(Math.max(0, rawPos.start - 10000), rawPos.start);
                asOfDate = findAsOfDate(preceding) || asOfDate;
            }
        }
        if (asOfDate === 'Date not found') {
            asOfDate = findAsOfDate(html) || asOfDate;
        }

        allTableData.push({
            headers: headerTexts, rows: dataRows, matchedRows,
            matchedRow: matchedRows.length === 1 ? matchedRows[0].rowData : (matchedRows.length > 0 ? matchedRows[0].rowData : null),
            matchedShares: matchedRows.length === 1 ? matchedRows[0].shares : null,
            asOfDate, beneficialCol
        });
    }

    const matchedTable = allTableData.find(t => t.matchedRows?.length > 0) || null;
    const isDisambiguate = matchedTable?.matchedRows?.length > 1;
    return {
        found: matchedTable !== null && !isDisambiguate,
        disambiguate: isDisambiguate || false,
        matchedNames: matchedTable?.matchedRows?.map(r => r.name) ?? [],
        matchedShares: matchedTable?.matchedRows?.length === 1 ? matchedTable.matchedRows[0].shares : null,
        asOfDate: matchedTable?.asOfDate ?? 'Date not found',
        tables: allTableData,
        matchedTableIndex: matchedTable ? allTableData.indexOf(matchedTable) : 0
    };
}

// — Fix relative URLs in proxy HTML so images/assets load correctly —
function makeUrlsAbsolute(html, docUrl) {
    // Derive the base directory from the document URL
    const baseUrl = docUrl.substring(0, docUrl.lastIndexOf('/') + 1);
    // Fix img src attributes (relative → absolute)
    html = html.replace(/(<img\b[^>]*?\bsrc\s*=\s*["'])(?!https?:\/\/|data:|#)([^"']+)(["'])/gi,
        (match, prefix, path, suffix) => {
            if (path.startsWith('/')) {
                // Absolute path — prepend origin
                const origin = new URL(docUrl).origin;
                return prefix + origin + path + suffix;
            }
            return prefix + baseUrl + path + suffix;
        });
    // Also fix background image url() references
    html = html.replace(/(url\(\s*["']?)(?!https?:\/\/|data:|#)([^"')]+)(["']?\s*\))/gi,
        (match, prefix, path, suffix) => {
            if (path.startsWith('/')) {
                const origin = new URL(docUrl).origin;
                return prefix + origin + path + suffix;
            }
            return prefix + baseUrl + path + suffix;
        });
    return html;
}

// — Render results —
function renderResults(result, company, ticker, personName, fileDate, docUrl, fullProxyHtml) {
    const banner = $('resultBanner');
    const summaryEl = $('resultSummary');
    const metaEl = $('resultMeta');
    const detailRow = $('detailRow');

    if (result.disambiguate) {
        banner.className = 'result-banner visible';
        banner.style.background = '#fff8e1';
        summaryEl.textContent = '';
        summaryEl.appendChild(document.createTextNode('Multiple matches for \u201c'));
        const strong = document.createElement('strong');
        strong.textContent = personName;
        summaryEl.appendChild(strong);
        summaryEl.appendChild(document.createTextNode('\u201d. Did you mean:'));
        summaryEl.style.color = 'var(--text)';
        metaEl.textContent = '';
        result.matchedNames.forEach((n, i) => {
            if (i > 0) metaEl.appendChild(document.createTextNode(' or '));
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'disambig-link';
            a.style.cssText = 'color:var(--navy);font-weight:600;text-decoration:underline;cursor:pointer;margin-right:4px;';
            a.textContent = n;
            metaEl.appendChild(a);
        });
        detailRow.style.display = 'none';

        // Click handler for disambiguation links
        metaEl.querySelectorAll('.disambig-link').forEach(link => {
            link.addEventListener('click', (ev) => {
                ev.preventDefault();
                $('person').value = link.textContent;
                $('searchForm').dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}));
            });
        });
    } else if (result.found && result.matchedShares !== null) {
        const displayName = (result.matchedNames && result.matchedNames.length === 1) ? result.matchedNames[0] : personName;
        banner.className = 'result-banner visible success';
        banner.style.background = '';
        summaryEl.style.color = '';
        summaryEl.textContent = `${displayName} owns ${result.matchedShares.toLocaleString()} shares`;
        metaEl.textContent = `${company} (${ticker.toUpperCase()}) · As of ${result.asOfDate} · DEF 14A filed ${fileDate}`;

        detailRow.style.display = 'flex';
        detailRow.textContent = '';
        function makeDetailItem(labelText, valueText, extraClass) {
            const item = document.createElement('div');
            item.className = 'detail-item';
            const lbl = document.createElement('label');
            lbl.textContent = labelText;
            item.appendChild(lbl);
            const val = document.createElement('div');
            val.className = extraClass ? 'value ' + extraClass : 'value';
            val.textContent = valueText;
            item.appendChild(val);
            return item;
        }
        detailRow.appendChild(makeDetailItem('Company', company));
        detailRow.appendChild(makeDetailItem('Ticker', ticker.toUpperCase()));
        detailRow.appendChild(makeDetailItem('Shares', result.matchedShares.toLocaleString(), 'shares'));
        detailRow.appendChild(makeDetailItem('As Of', result.asOfDate));
    } else if (result.found) {
        const displayName = (result.matchedNames && result.matchedNames.length === 1) ? result.matchedNames[0] : personName;
        banner.className = 'result-banner visible success';
        banner.style.background = '';
        summaryEl.style.color = '';
        summaryEl.textContent = `${displayName} found (share count unclear)`;
        metaEl.textContent = `${company} (${ticker.toUpperCase()}) · DEF 14A filed ${fileDate}`;
        detailRow.style.display = 'none';
    } else {
        banner.className = 'result-banner visible error';
        banner.style.background = '';
        summaryEl.style.color = '';
        summaryEl.textContent = `"${personName}" not found in ownership tables`;
        metaEl.textContent = `${company} (${ticker.toUpperCase()}) · Searched ${result.tables.length} table(s)`;
        detailRow.style.display = 'none';
    }

    // Filing link
    const link = $('filingLink');
    link.href = docUrl;
    link.style.display = 'inline-block';

    // Embed proxy document in the right panel
    if (fullProxyHtml) {
        const rightPanel = $('rightPanel');
        $('welcomeState').classList.add('hidden');

        // Remove old iframe
        const oldIframe = rightPanel.querySelector('iframe');
        if (oldIframe) oldIframe.remove();

        const iframe = document.createElement('iframe');
        iframe.sandbox = 'allow-same-origin allow-scripts';
        rightPanel.appendChild(iframe);

        const injectedCode = `
            <style>
                tr.wa-highlight td {
                    background: #fff8e1 !important;
                    font-weight: 600;
                }
            </style>
            <script>
                // Intercept internal anchor links so they work inside srcdoc
                document.addEventListener('click', function(e) {
                    var anchor = e.target.closest('a[href^="#"]');
                    if (!anchor) return;
                    var hash = anchor.getAttribute('href');
                    if (!hash || hash === '#') return;
                    e.preventDefault();
                    var targetId = hash.substring(1);
                    var target = document.getElementById(targetId);
                    if (!target) {
                        target = document.querySelector('[name="' + CSS.escape(targetId) + '"]');
                    }
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            <\/script>
        `;

        let modifiedHtml = makeUrlsAbsolute(fullProxyHtml, docUrl);
        // Sanitize SEC HTML: strip <script> tags to prevent XSS
        modifiedHtml = modifiedHtml.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

        const headClose = modifiedHtml.toLowerCase().indexOf('</head>');
        if (headClose > -1) {
            modifiedHtml = modifiedHtml.substring(0, headClose) + injectedCode + modifiedHtml.substring(headClose);
        } else {
            modifiedHtml = injectedCode + modifiedHtml;
        }
        iframe.srcdoc = modifiedHtml;

        // Highlight matching row and scroll to it from the parent
        // (more reliable than injected scripts which have timing issues in srcdoc)
        iframe.addEventListener('load', function() {
            try {
                const doc = iframe.contentDocument;
                if (!doc) return;
                const pn = personName.toLowerCase();
                const pParts = pn.split(/\s+/);
                const pLast = pParts[pParts.length - 1];
                const pFirst = pParts[0];
                const tables = doc.querySelectorAll('table');
                let scrollTarget = null;
                for (let t = 0; t < tables.length; t++) {
                    const txt = tables[t].textContent.toLowerCase();
                    if ((txt.indexOf('beneficial own') > -1 || txt.indexOf('amount and nature') > -1) &&
                        (txt.indexOf('name') > -1 || txt.indexOf('beneficial owner') > -1)) {
                        const rows = tables[t].querySelectorAll('tr');
                        for (let r = 0; r < rows.length; r++) {
                            const cell = rows[r].querySelector('td');
                            if (cell) {
                                const ct = cell.textContent.replace(/\u00a0/g, ' ').toLowerCase();
                                if (ct.indexOf(pn) > -1 || (ct.indexOf(pLast) > -1 && ct.indexOf(pFirst) > -1)) {
                                    rows[r].classList.add('wa-highlight');
                                    if (!scrollTarget) scrollTarget = rows[r];
                                }
                            }
                        }
                        if (!scrollTarget) scrollTarget = tables[t];
                        break;
                    }
                }
                if (scrollTarget) {
                    setTimeout(() => scrollTarget.scrollIntoView({ block: 'center' }), 100);
                }
            } catch (e) { /* cross-origin error, ignore */ }
        });
    }
}

// — Calculator —
let calcProxyShares = 0;
let calcAsOfDate = '';

function parseCalcInput(id) {
    const raw = $(id).value.replace(/,/g, '').trim();
    const n = parseInt(raw, 10);
    return isNaN(n) || n < 0 ? 0 : n;
}

function recalculate() {
    const sold = parseCalcInput('calcSold');
    const add1 = parseCalcInput('calcAdd1');
    const add2 = parseCalcInput('calcAdd2');
    const add3 = parseCalcInput('calcAdd3');
    const sub1 = parseCalcInput('calcSub1');
    const sub2 = parseCalcInput('calcSub2');
    const sub3 = parseCalcInput('calcSub3');

    const totalAdded = add1 + add2 + add3;
    const totalSubtracted = sub1 + sub2 + sub3;
    const adjustedBase = calcProxyShares + totalAdded - totalSubtracted;

    let pct = 0;
    if (adjustedBase > 0 && sold > 0) {
        pct = (sold / adjustedBase) * 100;
    }

    const pctEl = $('calcPct');
    pctEl.textContent = pct.toFixed(1) + '%';

    const badgeEl = $('calcBadge');
    const resultEl = $('calcResult');
    resultEl.classList.remove('severity-high-glow');

    if (sold === 0) {
        pctEl.style.color = 'var(--text-muted)';
    } else if (pct < 10) {
        pctEl.style.color = '#2e7d32';
    } else if (pct <= 30) {
        pctEl.style.color = '#e65100';
    } else {
        pctEl.style.color = '#bf360c';
        resultEl.classList.add('severity-high-glow');
    }
    badgeEl.innerHTML = '';

    const bk = $('calcBreakdown');
    bk.textContent = '';
    function numSpan(value) {
        const s = document.createElement('span');
        s.className = 'num';
        s.textContent = value.toLocaleString();
        return s;
    }
    bk.appendChild(document.createTextNode('Proxy: '));
    bk.appendChild(numSpan(calcProxyShares));
    if (totalAdded > 0) {
        bk.appendChild(document.createTextNode(' + '));
        bk.appendChild(numSpan(totalAdded));
    }
    if (totalSubtracted > 0) {
        bk.appendChild(document.createTextNode(' \u2212 '));
        bk.appendChild(numSpan(totalSubtracted));
    }
    bk.appendChild(document.createTextNode(' = '));
    bk.appendChild(numSpan(adjustedBase));
    bk.appendChild(document.createTextNode(' adj. base'));
    if (sold > 0) {
        bk.appendChild(document.createElement('br'));
        bk.appendChild(document.createTextNode('Sold '));
        bk.appendChild(numSpan(sold));
        bk.appendChild(document.createTextNode(' of '));
        bk.appendChild(numSpan(adjustedBase));
    }
}

function showCalc(proxyShares, asOfDate) {
    calcProxyShares = proxyShares;
    calcAsOfDate = asOfDate;
    $('adjustTitle').textContent = `Adjustments since ${asOfDate}`;
    ['calcSold','calcAdd1','calcAdd2','calcAdd3','calcSub1','calcSub2','calcSub3'].forEach(id => $(id).value = '');
    $('calcSection').classList.add('visible');
    recalculate();
}

function hideCalc() {
    $('calcSection').classList.remove('visible');
}

// — Main search flow —
$('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const ticker = $('ticker').value.trim();
    const personName = $('person').value.trim();
    if (!ticker || !personName) return;

    clearError();
    $('resultBanner').className = 'result-banner';
    $('detailRow').style.display = 'none';
    hideCalc();
    $('filingLink').style.display = 'none';
    $('searchBtn').disabled = true;

    const steps = [
        { label: `Resolving ${ticker.toUpperCase()}`, status: 'active' },
        { label: 'Finding DEF 14A', status: 'pending' },
        { label: 'Fetching proxy', status: 'pending' },
        { label: 'Parsing', status: 'pending' },
    ];

    const updateStep = (idx, status) => { steps[idx].status = status; setSteps(steps); };
    setSteps(steps);

    try {
        const { cik, company } = await resolveTicker(ticker);
        updateStep(0, 'done');
        steps[0].label = company;
        updateStep(1, 'active');
        setSteps(steps);
        await delay(200);

        const { adsh, filename, fileDate } = await findLatestProxy(cik);
        updateStep(1, 'done');
        steps[1].label = `Filed ${fileDate}`;
        updateStep(2, 'active');
        setSteps(steps);

        const docUrl = buildDocUrl(cik, adsh, filename);
        const html = await fetchProxyHtml(docUrl);
        updateStep(2, 'done');
        updateStep(3, 'active');
        setSteps(steps);
        await delay(100);

        const result = parseOwnershipFromHtml(html, personName);
        updateStep(3, 'done');
        steps[3].label = `${result.tables.length} table(s)`;
        setSteps(steps);

        renderResults(result, company, ticker, personName, fileDate, docUrl, html);

        if (result.found && result.matchedShares !== null) {
            showCalc(result.matchedShares, result.asOfDate);
        } else {
            hideCalc();
        }

        // Clear progress after a moment
        setTimeout(clearSteps, 2000);

    } catch (err) {
        showError(err.message);
        for (const s of steps) { if (s.status === 'active') s.status = 'done'; }
        setSteps(steps);
    } finally {
        $('searchBtn').disabled = false;
    }
});
</script>

</body>
</html>
